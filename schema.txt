2025-06-25 11:34:28,519 - root - INFO - ✅ Integration 'connectwise' detected and loaded
2025-06-25 11:34:28,520 - root - INFO - ⚠️ Integration 'businesscentral' not available (package not installed)
2025-06-25 11:34:28,521 - root - INFO - ⚠️ Integration 'jira' not available (package not installed)
2025-06-25 11:34:28,521 - root - INFO - Running ETL pipeline for integrations: ['connectwise']
2025-06-25 11:34:28,522 - root - INFO - Processing layers: ['gold']
2025-06-25 11:34:28,522 - root - INFO - Mode: full, Lookback days: 30
2025-06-25 11:34:28,522 - root - INFO - Processing integration: connectwise in full mode
2025-06-25 11:34:28,523 - root - INFO - Running gold layer for connectwise
2025-06-25 11:34:28,528 - root - INFO - Using ConnectWise-specific transforms
2025-06-25 11:34:40,047 - root - INFO - Using ConnectWise agreement-specific transforms
2025-06-25 11:34:41,899 - root - ERROR - Gold processing failed for agreement: [_LEGACY_ERROR_TEMP_DELTA_0007] A schema mismatch detected when writing to the Delta table (Table ID: 9389b3a0-86ce-44a5-90bc-8990b7ef842f).
To enable schema migration using DataFrameWriter or DataStreamWriter, please set:
'.option("mergeSchema", "true")'.
For other operations, set the session configuration
spark.databricks.delta.schema.autoMerge.enabled to "true". See the documentation
specific to the operation for details.

Table schema:
root
-- period_start: date (nullable = true)
-- period_end: date (nullable = true)
-- year: integer (nullable = true)
-- month: integer (nullable = true)
-- quarter: integer (nullable = true)
-- id: integer (nullable = true)
-- name: string (nullable = true)
-- agreementStatus: string (nullable = true)
-- typeId: integer (nullable = true)
-- typeName: string (nullable = true)
-- companyId: integer (nullable = true)
-- contactId: integer (nullable = true)
-- billingCycleId: integer (nullable = true)
-- billAmount: double (nullable = true)
-- applicationUnits: string (nullable = true)
-- effective_start: date (nullable = true)
-- effective_end: timestamp (nullable = true)
-- cancelledFlag: boolean (nullable = true)
-- customFields: string (nullable = true)
-- is_active_period: boolean (nullable = true)
-- is_new_agreement: boolean (nullable = true)
-- is_churned_agreement: boolean (nullable = true)
-- monthly_revenue: double (nullable = true)
-- days_in_period: integer (nullable = true)
-- prorated_revenue: double (nullable = true)
-- months_since_start: double (nullable = true)
-- revenue_change: double (nullable = true)
-- cumulative_revenue: double (nullable = true)
-- AgreementPeriodSK: string (nullable = true)


Data schema:
root
-- id: integer (nullable = true)
-- name: string (nullable = true)
-- agreementStatus: string (nullable = true)
-- typeId: integer (nullable = true)
-- typeName: string (nullable = true)
-- companyId: integer (nullable = true)
-- companyName: string (nullable = true)
-- contactId: integer (nullable = true)
-- billingCycleId: integer (nullable = true)
-- billAmount: double (nullable = true)
-- applicationUnits: string (nullable = true)
-- effective_start: date (nullable = true)
-- effective_end: timestamp (nullable = true)
-- cancelledFlag: boolean (nullable = true)
-- customFields: string (nullable = true)
-- period_start: date (nullable = true)
-- period_end: date (nullable = true)
-- year: integer (nullable = true)
-- month: integer (nullable = true)
-- quarter: integer (nullable = true)
-- is_active_period: boolean (nullable = true)
-- is_new_agreement: boolean (nullable = true)
-- is_churned_agreement: boolean (nullable = true)
-- monthly_revenue: double (nullable = true)
-- months_since_start: double (nullable = true)
-- AgreementPeriodSK: string (nullable = true)
-- AgreementSK: string (nullable = true)
-- PeriodDateSK: integer (nullable = true)

         
To overwrite your schema or change partitioning, please set:
'.option("overwriteSchema", "true")'.

Note that the schema can't be overwritten when using
'replaceWhere'.
         
2025-06-25 11:34:43,906 - root - INFO - Using ConnectWise invoice-specific transforms
2025-06-25 11:34:43,907 - unified_etl_connectwise.transforms - INFO - Creating comprehensive invoice line facts
2025-06-25 11:34:43,918 - unified_etl_connectwise.transforms - INFO - Resolving agreement hierarchy for invoice_lines
2025-06-25 11:34:43,920 - unified_etl_connectwise.agreement_utils - INFO - Resolving agreement hierarchy for invoice_lines
2025-06-25 11:34:52,103 - unified_etl_connectwise.transforms - INFO - Added 330375 time-based lines
2025-06-25 11:34:54,608 - unified_etl_connectwise.transforms - INFO - Added 384415 product lines
2025-06-25 11:34:56,291 - root - ERROR - Gold processing failed for invoice: [DELTA_FAILED_TO_MERGE_FIELDS] Failed to merge fields 'cost' and 'cost'
2025-06-25 11:34:56,417 - root - INFO - Using ConnectWise time entry-specific transforms
2025-06-25 11:34:56,980 - unified_etl_connectwise.agreement_utils - INFO - Resolving agreement hierarchy for time_entries
2025-06-25 11:34:58,631 - root - ERROR - Gold processing failed for timeentry: [DELTA_FAILED_TO_MERGE_FIELDS] Failed to merge fields 'TimeentrySK' and 'TimeentrySK'
2025-06-25 11:34:59,134 - root - INFO - Using ConnectWise expense entry-specific transforms
2025-06-25 11:34:59,341 - unified_etl_connectwise.agreement_utils - INFO - Resolving agreement hierarchy for expenses
2025-06-25 11:35:00,855 - root - ERROR - Gold processing failed for expenseentry: [_LEGACY_ERROR_TEMP_DELTA_0007] A schema mismatch detected when writing to the Delta table (Table ID: ae1c71e1-a667-4c6c-85cf-578a1ae12265).
To enable schema migration using DataFrameWriter or DataStreamWriter, please set:
'.option("mergeSchema", "true")'.
For other operations, set the session configuration
spark.databricks.delta.schema.autoMerge.enabled to "true". See the documentation
specific to the operation for details.

Table schema:
root
-- id: integer (nullable = true)
-- expenseReportId: integer (nullable = true)
-- expenseReportName: string (nullable = true)
-- expenseReport_info: string (nullable = true)
-- companyId: integer (nullable = true)
-- companyIdentifier: string (nullable = true)
-- companyName: string (nullable = true)
-- company_info: string (nullable = true)
-- chargeToId: integer (nullable = true)
-- chargeToType: string (nullable = true)
-- typeId: integer (nullable = true)
-- typeName: string (nullable = true)
-- type_info: string (nullable = true)
-- memberId: integer (nullable = true)
-- memberIdentifier: string (nullable = true)
-- memberName: string (nullable = true)
-- memberDailyCapacity: double (nullable = true)
-- member_info: string (nullable = true)
-- paymentMethodId: integer (nullable = true)
-- paymentMethodName: string (nullable = true)
-- paymentMethod_info: string (nullable = true)
-- classificationId: integer (nullable = true)
-- classificationName: string (nullable = true)
-- classification_info: string (nullable = true)
-- amount: double (nullable = true)
-- billableOption: string (nullable = true)
-- date: timestamp (nullable = true)
-- locationId: integer (nullable = true)
-- businessUnitId: integer (nullable = true)
-- notes: string (nullable = true)
-- agreementId: integer (nullable = true)
-- agreementName: string (nullable = true)
-- agreementType: string (nullable = true)
-- agreementChargeFirmFlag: boolean (nullable = true)
-- agreement_info: string (nullable = true)
-- invoiceAmount: double (nullable = true)
-- mobileGuid: string (nullable = true)
-- taxes: string (nullable = true)
-- invoiceId: integer (nullable = true)
-- invoiceIdentifier: string (nullable = true)
-- invoiceBillingType: string (nullable = true)
-- invoiceApplyToType: string (nullable = true)
-- invoiceInvoiceDate: string (nullable = true)
-- invoiceChargeFirmFlag: boolean (nullable = true)
-- invoice_info: string (nullable = true)
-- currencyId: integer (nullable = true)
-- currencySymbol: string (nullable = true)
-- currencyCurrencyCode: string (nullable = true)
-- currencyDecimalSeparator: string (nullable = true)
-- currencyNumberOfDecimals: integer (nullable = true)
-- currencyThousandsSeparator: string (nullable = true)
-- currencyNegativeParenthesesFlag: boolean (nullable = true)
-- currencyDisplaySymbolFlag: boolean (nullable = true)
-- currencyCurrencyIdentifier: string (nullable = true)
-- currencyDisplayIdFlag: boolean (nullable = true)
-- currencyRightAlign: boolean (nullable = true)
-- currencyName: string (nullable = true)
-- currency_info: string (nullable = true)
-- status: string (nullable = true)
-- billAmount: double (nullable = true)
-- agreementAmount: double (nullable = true)
-- odometerStart: double (nullable = true)
-- odometerEnd: double (nullable = true)
-- ticketId: integer (nullable = true)
-- ticketSummary: string (nullable = true)
-- ticket_info: string (nullable = true)
-- projectId: integer (nullable = true)
-- projectName: string (nullable = true)
-- project_info: string (nullable = true)
-- phaseId: integer (nullable = true)
-- phaseName: string (nullable = true)
-- phase_info: string (nullable = true)
-- _info: string (nullable = true)
-- customFields: string (nullable = true)
-- etlTimestamp: string (nullable = true)
-- etlEntity: string (nullable = true)
-- _etl_processed_at: timestamp (nullable = true)
-- _etl_source: string (nullable = true)
-- _etl_batch_id: string (nullable = true)
-- ExpenseentrySK: integer (nullable = true)
-- ExpenseentryBusinessKey: integer (nullable = true)
-- _etl_gold_processed_at: timestamp (nullable = true)
-- EntityType: string (nullable = true)


Data schema:
root
-- ExpenseSK: string (nullable = true)
-- expenseId: integer (nullable = true)
-- memberId: integer (nullable = true)
-- agreementId: integer (nullable = true)
-- chargeToId: integer (nullable = true)
-- chargeToType: string (nullable = true)
-- invoiceId: integer (nullable = true)
-- ticketId: integer (nullable = true)
-- projectId: integer (nullable = true)
-- expenseTypeId: integer (nullable = true)
-- expenseTypeName: string (nullable = true)
-- billableOption: string (nullable = true)
-- amount: double (nullable = true)
-- quantity: integer (nullable = true)
-- date: timestamp (nullable = true)
-- notes: string (nullable = true)
-- ExpenseDateSK: integer (nullable = true)
-- totalAmount: double (nullable = true)
-- totalCost: integer (nullable = true)
-- margin: double (nullable = true)
-- agreement_type: string (nullable = true)
-- agreement_type_normalized: string (nullable = true)
-- agreement_billing_behavior: string (nullable = true)
-- parentAgreementId: integer (nullable = true)
-- final_agreement_number: string (nullable = true)
-- isBillableWork: boolean (nullable = true)
-- isTimapottur: boolean (nullable = true)
-- isInternalWork: boolean (nullable = true)
-- isOperations: boolean (nullable = true)
-- effectiveBillingStatus: string (nullable = true)
-- _etl_gold_processed_at: timestamp (nullable = true)
-- _etl_source: string (nullable = true)
-- _etl_batch_id: string (nullable = true)

         
To overwrite your schema or change partitioning, please set:
'.option("overwriteSchema", "true")'.

Note that the schema can't be overwritten when using
'replaceWhere'.
         
2025-06-25 11:35:00,984 - root - INFO - Using generic fact table creation for productitem

✅ Incremental update complete!
